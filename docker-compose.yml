version: '3.8'

# SAP Workflow Mining - Docker Compose Configuration
#
# Services:
#   - synthetic-data: Generates synthetic SAP SD documents
#   - mcp-server: MCP server exposing SAP-shaped tools
#   - pattern-engine: Pattern discovery and correlation engine
#   - viewer: Web-based results viewer
#
# Usage:
#   docker-compose up --build          # Build and run all services
#   docker-compose up synthetic-data   # Run data generation only
#   docker-compose up -d mcp-server    # Run MCP server in background
#   docker-compose logs -f pattern-engine  # Follow pattern engine logs
#   docker-compose down                # Stop all services

services:
  # ===========================================================================
  # Synthetic Data Generator
  # ===========================================================================
  synthetic-data:
    build:
      context: ./synthetic-data
      dockerfile: Dockerfile
    container_name: sap-wm-synthetic-data
    volumes:
      - ./synthetic-data/sample_output:/app/output
    environment:
      - DATA_COUNT=${DATA_COUNT:-10000}
      - DATA_SEED=${DATA_SEED:-42}
      - OUTPUT_DIR=/app/output
    command: >
      python src/generate_sd.py
        --count ${DATA_COUNT:-10000}
        --seed ${DATA_SEED:-42}
        --output /app/output
    networks:
      - sap-wm-network

  # ===========================================================================
  # MCP Server
  # ===========================================================================
  mcp-server:
    build:
      context: ./mcp-server
      dockerfile: Dockerfile
    container_name: sap-wm-mcp-server
    ports:
      - "${SERVER_PORT:-3000}:3000"
    volumes:
      - ./synthetic-data/sample_output:/app/data:ro
      - ./output/logs:/app/logs
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATA_DIR=/app/data
      - LOG_DIR=/app/logs
    depends_on:
      synthetic-data:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - sap-wm-network

  # ===========================================================================
  # MCP Server with RFC Support (Profile: rfc)
  # ===========================================================================
  # This service requires:
  # 1. SAP NW RFC SDK in mcp-server/nwrfc-sdk/
  # 2. .env.rfc file with SAP connection parameters
  #
  # Usage:
  #   docker-compose --profile rfc up mcp-server-rfc
  #
  mcp-server-rfc:
    build:
      context: ./mcp-server
      dockerfile: Dockerfile.rfc
    container_name: sap-wm-mcp-server-rfc
    profiles:
      - rfc
    ports:
      - "${RFC_SERVER_PORT:-3001}:3000"
    volumes:
      - ./output/logs:/app/logs
    environment:
      - NODE_ENV=production
      - PORT=3000
      - LOG_DIR=/app/logs
      - SAP_ADAPTER=ecc_rfc
      - SAP_RFC_ASHOST=${SAP_RFC_ASHOST}
      - SAP_RFC_SYSNR=${SAP_RFC_SYSNR:-00}
      - SAP_RFC_CLIENT=${SAP_RFC_CLIENT:-100}
      - SAP_RFC_USER=${SAP_RFC_USER}
      - SAP_RFC_PASSWD=${SAP_RFC_PASSWD}
      - SAP_RFC_LANG=${SAP_RFC_LANG:-EN}
      - SAP_RFC_POOL_SIZE=${SAP_RFC_POOL_SIZE:-5}
      - SAP_RFC_TRACE=${SAP_RFC_TRACE:-0}
      - SAP_RFC_TIMEOUT=${SAP_RFC_TIMEOUT:-30000}
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - sap-wm-network

  # ===========================================================================
  # Pattern Engine
  # ===========================================================================
  pattern-engine:
    build:
      context: ./pattern-engine
      dockerfile: Dockerfile
    container_name: sap-wm-pattern-engine
    volumes:
      - ./synthetic-data/sample_output:/app/data:ro
      - ./output:/app/output
    environment:
      - INPUT_DIR=/app/data
      - OUTPUT_DIR=/app/output
      - PYTHONUNBUFFERED=1
    depends_on:
      synthetic-data:
        condition: service_completed_successfully
    command: >
      python -m src.main run
        --input-dir /app/data
        --output-dir /app/output
        --mode shareable
    networks:
      - sap-wm-network

  # ===========================================================================
  # Results Viewer
  # ===========================================================================
  viewer:
    build:
      context: ./viewer
      dockerfile: Dockerfile
    container_name: sap-wm-viewer
    ports:
      - "${VIEWER_PORT:-8080}:8080"
    volumes:
      - ./output:/app/output:ro
    environment:
      - PORT=8080
      - OUTPUT_DIR=/app/output
    depends_on:
      pattern-engine:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    networks:
      - sap-wm-network

# ===========================================================================
# Networks
# ===========================================================================
networks:
  sap-wm-network:
    name: sap-workflow-mining
    driver: bridge

# ===========================================================================
# Volumes (optional persistent storage)
# ===========================================================================
volumes:
  synthetic-data-output:
    name: sap-wm-synthetic-data
  analysis-output:
    name: sap-wm-analysis-output
